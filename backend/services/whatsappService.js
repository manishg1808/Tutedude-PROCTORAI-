class WhatsAppService {
  constructor() {
    this.phoneNumber = '918986010809'; // Your WhatsApp number with country code
  }

  async sendInterviewReport(interviewData) {
    try {
      const message = this.formatInterviewMessage(interviewData);
      
      // Create WhatsApp Web URL that opens directly
      const whatsappUrl = `https://web.whatsapp.com/send?phone=${this.phoneNumber}&text=${encodeURIComponent(message)}`;
      
      console.log('WhatsApp URL generated:', whatsappUrl);
      console.log('Message to send:', message);
      
      return {
        success: true,
        whatsappUrl: whatsappUrl,
        message: message,
        instructions: 'Click the link to open WhatsApp and send the message'
      };
    } catch (error) {
      console.error('Error creating WhatsApp message:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  formatInterviewMessage(interviewData) {
    const {
      candidateName,
      candidateEmail,
      integrityScore,
      duration,
      totalEvents,
      focusLostCount,
      suspiciousEventsCount,
      endTime
    } = interviewData;

    const status = integrityScore >= 90 ? 'âœ… EXCELLENT' : 
                  integrityScore >= 70 ? 'âš ï¸ GOOD' : 
                  integrityScore >= 50 ? 'ğŸ”¶ FAIR' : 'âŒ POOR';

    return `ğŸ¯ *ProctorAI Interview Report*

ğŸ‘¤ *Candidate:* ${candidateName}
ğŸ“§ *Email:* ${candidateEmail}
â±ï¸ *Duration:* ${Math.floor(duration / 60)}m ${duration % 60}s
ğŸ“… *Completed:* ${new Date(endTime).toLocaleString()}

ğŸ“Š *INTEGRITY SCORE: ${integrityScore}/100* ${status}

ğŸ“ˆ *Event Summary:*
â€¢ Total Events: ${totalEvents}
â€¢ Focus Lost: ${focusLostCount}
â€¢ Suspicious Activities: ${suspiciousEventsCount}

ğŸ” *Detailed Analysis:*
${integrityScore >= 90 ? 'â€¢ No significant violations detected' : ''}
${focusLostCount > 0 ? `â€¢ Focus lost ${focusLostCount} times` : ''}
${suspiciousEventsCount > 0 ? `â€¢ ${suspiciousEventsCount} suspicious activities flagged` : ''}

ğŸ’¡ *Recommendation:* ${this.getRecommendation(integrityScore)}

---
ğŸ¤– Generated by ProctorAI System
â° ${new Date().toLocaleString()}`;
  }

  getRecommendation(score) {
    if (score >= 90) {
      return 'Candidate performed excellently. No concerns detected.';
    } else if (score >= 70) {
      return 'Good performance with minor issues. Standard review recommended.';
    } else if (score >= 50) {
      return 'Multiple violations detected. Manual review required.';
    } else {
      return 'Significant integrity concerns. Immediate review and follow-up needed.';
    }
  }

  // Alternative method using WhatsApp Business API
  async sendViaAPI(message) {
    // This would require WhatsApp Business API credentials
    // For now, we'll just log the message
    console.log('WhatsApp API Message:', message);
    
    // Example with Twilio WhatsApp API:
    /*
    const client = require('twilio')(accountSid, authToken);
    
    await client.messages.create({
      from: 'whatsapp:+14155238886',
      body: message,
      to: `whatsapp:+${this.phoneNumber}`
    });
    */
  }

  // Send real-time alerts during interview
  async sendAlert(alertData) {
    const { eventType, description, severity, timestamp } = alertData;
    
    const alertMessage = `ğŸš¨ *ProctorAI Alert*

âš ï¸ *Event:* ${eventType.replace('_', ' ').toUpperCase()}
ğŸ“ *Description:* ${description}
ğŸ”´ *Severity:* ${severity.toUpperCase()}
â° *Time:* ${new Date(timestamp).toLocaleString()}

${severity === 'critical' ? 'ğŸ”´ IMMEDIATE ATTENTION REQUIRED' : ''}
${severity === 'high' ? 'ğŸŸ¡ HIGH PRIORITY ALERT' : ''}
${severity === 'medium' ? 'ğŸŸ  MEDIUM PRIORITY' : ''}

---
ğŸ¤– ProctorAI Real-time Monitoring`;

    try {
      const whatsappUrl = `${this.apiUrl}?phone=${this.phoneNumber}&text=${encodeURIComponent(alertMessage)}`;
      
      console.log('Alert WhatsApp URL:', whatsappUrl);
      
      return {
        success: true,
        whatsappUrl: whatsappUrl,
        message: alertMessage
      };
    } catch (error) {
      console.error('Error sending alert:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
}

module.exports = new WhatsAppService();
